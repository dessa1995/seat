<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자리 배치 프로그램</title>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- SheetJS for XLSX parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* --- Fonts and Basic Styles --- */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        
        :root {
            --bg-color: #f0f8ff;
            --border-color: #4a4a4a;
            --desk-bg: #ffffff;
            --desk-fixed-bg: #ffd700;
            --desk-hidden-bg: #a0a0a0;
            --button-bg: #e0e0e0;
            --button-hover-bg: #c0c0c0;
            --accent-color: #ff6347;
            --text-color: #333;
        }

        body {
            font-family: 'Noto Sans KR', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: 100vh;
            box-sizing: border-box;
        }

        /* --- Custom Border Style --- */
        .custom-border {
            border: 4px solid var(--border-color);
            box-shadow: 4px 4px 0px 0px var(--border-color);
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
        }

        h1 {
            text-align: center;
            margin-bottom: 0;
        }

        h2, h3 {
            margin: 0 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 4px solid var(--border-color);
        }

        /* --- Layout: Controls and Seating Chart --- */
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            flex-grow: 1;
            min-height: 0;
        }

        .controls {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .seating-chart-container {
            flex: 3;
            min-width: 400px;
            position: relative;
            overflow: hidden; /* Important for scaling */
        }

        /* --- Buttons and Inputs --- */
        .btn, a.btn {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1rem;
            padding: 0.75rem 1rem;
            border: 4px solid var(--border-color);
            background-color: var(--button-bg);
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
            box-shadow: 4px 4px 0px 0px var(--border-color);
            text-decoration: none;
            color: var(--text-color);
            display: inline-block;
            text-align: center;
            border-radius: 4px;
        }

        .btn:hover, .btn:focus, a.btn:hover, a.btn:focus {
            background-color: var(--button-hover-bg);
            box-shadow: 2px 2px 0px 0px var(--border-color);
            transform: translate(2px, 2px);
        }
        
        .btn:active, a.btn:active {
            box-shadow: 0px 0px 0px 0px var(--border-color);
            transform: translate(4px, 4px);
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        #delete-all-students {
            background-color: var(--accent-color);
            color: white;
        }
        #delete-all-students:hover {
            background-color: #e55337;
        }

        input[type="text"], input[type="number"] {
            font-family: 'Noto Sans KR', sans-serif;
            font-size: 1rem;
            padding: 0.5rem;
            border: 4px solid var(--border-color);
            width: calc(100% - 1.5rem);
            border-radius: 4px;
        }
        
        .gender-select, #student-form > div {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        #student-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .help-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* --- Custom Layout Controls --- */
        .layout-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .layout-controls div {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #layout-cols, #group-size {
            width: 80px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .switch input { display:none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border: 2px solid var(--border-color);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border: 2px solid var(--border-color);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--accent-color);
        }
        input:checked + .slider:before {
            transform: translateX(20px);
        }


        /* --- Student List --- */
        #student-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 4px solid var(--border-color);
            margin-top: 1rem;
            border-radius: 4px;
        }

        #student-list li {
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
            gap: 0.5rem;
        }
        #student-list li:nth-child(even) {
            background-color: #f2f2f2;
        }
        .list-btn-group {
            display: flex;
            gap: 0.5rem;
        }
        .btn-edit, .btn-remove {
             background: var(--button-bg);
             border: 2px solid var(--border-color);
             font-family: 'Noto Sans KR', sans-serif;
             cursor: pointer;
             font-weight: bold;
             padding: 2px 5px;
             border-radius: 4px;
        }

        /* --- Seating Chart & Desks --- */
        #teacher-desk {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 50px;
            background-color: #e6e6e6;
            border: 4px solid var(--border-color);
            box-shadow: 4px 4px 0px 0px var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            z-index: 10;
            border-radius: 8px;
        }
        
        #seating-chart {
            position: absolute;
            transform-origin: top left; /* Important for scaling */
            transition: transform 0.3s ease-in-out, top 0.3s ease-in-out, left 0.3s ease-in-out;
        }
        
        .group-card {
            position: absolute;
            background-color: #f9f9f9;
            border: 3px dashed var(--border-color);
            border-radius: 8px;
            padding-top: 2.5rem;
        }
        .group-title {
            position: absolute;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 1.1rem;
            background: white;
            padding: 0 0.5rem;
        }

        .desk {
            position: absolute;
            width: 100px;
            height: 60px;
            background-color: var(--desk-bg);
            border: 4px solid var(--border-color);
            box-shadow: 4px 4px 0px 0px var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: grab;
            user-select: none;
            transition: background-color 0.3s, transform 0.3s;
            z-index: 1;
            border-radius: 8px;
        }
        .desk.dragging {
            z-index: 1000;
        }

        .desk.fixed {
            background-color: var(--desk-fixed-bg);
            cursor: default;
        }
        
        .desk.hidden .student-info {
            visibility: hidden;
        }
        
        .desk.hidden {
            background-color: var(--desk-hidden-bg);
        }

        .desk-header {
            position: absolute;
            top: -2px;
            right: -2px;
            display: flex;
            gap: 2px;
        }

        .desk-btn {
            font-size: 0.7rem;
            padding: 1px 3px;
            border: 2px solid var(--border-color);
            background-color: var(--button-bg);
            cursor: pointer;
            border-radius: 4px;
        }
        
        .student-info {
            text-align: center;
            font-size: 0.9rem;
            line-height: 1.2;
        }
        
        .student-name {
            font-weight: bold;
        }

        .student-gender {
            font-size: 0.8rem;
            color: #555;
        }

        /* --- Fullscreen Mode --- */
        #fullscreen-controls {
            display: none;
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2020;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 1rem;
            border-radius: 8px;
            border: 4px solid var(--border-color);
            box-shadow: 4px 4px 0px 0px var(--border-color);
        }
        body.fullscreen-mode #fullscreen-controls {
            display: flex;
            gap: 1rem;
        }
        body.fullscreen-mode .controls, body.fullscreen-mode h1 {
            display: none;
        }
        body.fullscreen-mode .seating-chart-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            border: none;
            box-shadow: none;
        }
        
        /* --- Modal --- */
        #confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }
        #confirm-modal {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            border: 4px solid var(--border-color);
            box-shadow: 4px 4px 0px 0px var(--border-color);
            text-align: center;
        }
        #confirm-modal p {
            font-size: 1.2rem;
            margin: 0 0 1.5rem 0;
        }
        #confirm-modal .btn-group {
            justify-content: center;
        }


        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            body {
                height: auto;
            }
            .app-container {
                flex-direction: column;
            }
            .controls, .seating-chart-container {
                width: 100%;
                min-height: 500px;
            }
        }
    </style>
</head>
<body>

    <h1>자리 배치 프로그램</h1>

    <div class="app-container">
        <!-- Control Panel -->
        <div class="controls custom-border">
            <!-- Student Management -->
            <section>
                <h2>학생 명렬</h2>
                <div class="btn-group">
                    <a href="https://drive.google.com/uc?export=download&id=14U3BCnAlipCbsPWru9v-FhlXM8fQC_w7" download="학생명단_양식.xlsx" class="btn">명단 양식 내려받기</a>
                    <button id="upload-file" class="btn">명단 업로드 (PC)</button>
                    <input type="file" id="file-input" accept=".csv, .xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;">
                </div>
                <div class="btn-group" style="margin-top: 0.5rem;">
                     <button id="download-current-csv" class="btn">현재 명단 저장</button>
                     <button id="delete-all-students" class="btn">명단 전체 삭제</button>
                </div>
                 <div id="student-form">
                    <input type="number" id="student-number" placeholder="번호 (자동 부여)">
                    <input type="text" id="student-name" placeholder="이름" required>
                    <div class="gender-select">
                        <label><input type="radio" name="gender" value="M" checked> 남</label>
                        <label><input type="radio" name="gender" value="F"> 여</label>
                    </div>
                    <button id="add-student-btn" class="btn">학생 추가</button>
                </div>
                <ul id="student-list"></ul>
            </section>

            <!-- Layout Selection -->
            <section>
                <h3>책상 배치 유형</h3>
                <div class="layout-controls">
                    <div id="standard-layout-controls">
                        <div>
                            <label for="pair-mode">짝꿍 모드</label>
                            <label class="switch">
                                <input type="checkbox" id="pair-mode">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <label for="layout-cols" id="layout-cols-label">한 줄에 5명</label>
                            <input type="number" id="layout-cols" value="5" min="1">
                        </div>
                    </div>
                     <hr>
                    <div id="group-layout-controls">
                         <div>
                            <label for="group-mode">모둠 구성</label>
                            <label class="switch">
                                <input type="checkbox" id="group-mode">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div id="group-size-control" style="display: none;">
                            <label for="group-size">한 모둠에</label>
                            <input type="number" id="group-size" value="4" min="2">
                             <span>명</span>
                        </div>
                    </div>
                    <button id="apply-layout" class="btn">배치 적용</button>
                </div>
            </section>

            <!-- Actions -->
            <section>
                <h3>기능</h3>
                <div class="btn-group">
                    <button id="shuffle-seats" class="btn">좌석 랜덤 배정</button>
                    <button id="reset-seats" class="btn">초기화</button>
                    <button id="toggle-hide" class="btn">책상 가리기</button>
                    <button id="fullscreen-btn" class="btn">전체 화면</button>
                    <button id="save-preset" class="btn">미리 저장</button>
                    <button id="export-pdf" class="btn">PDF로 저장</button>
                </div>
            </section>
        </div>

        <!-- Seating Chart -->
        <div id="seating-chart-area" class="seating-chart-container custom-border">
            <div id="teacher-desk">교탁</div>
            <div id="fullscreen-controls">
                <button id="fs-shuffle-btn" class="btn">랜덤 배정</button>
                <button id="fs-reset-btn" class="btn">초기화</button>
                <button id="fs-toggle-hide-btn" class="btn">책상 가리기</button>
                <button id="fs-save-preset-btn" class="btn">미리 저장</button>
                <button id="fs-export-pdf-btn" class="btn">PDF로 저장</button>
                <button id="exit-fullscreen-btn" class="btn">나가기</button>
            </div>
            <div id="seating-chart">
                <!-- Desks will be generated here -->
            </div>
        </div>
    </div>
    
    <div id="confirm-modal-overlay">
        <div id="confirm-modal">
            <p id="confirm-modal-message"></p>
            <div class="btn-group">
                <button id="confirm-modal-yes" class="btn">확인</button>
                <button id="confirm-modal-no" class="btn">취소</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- State Management ---
            let students = [];
            let desks = [];
            let nextStudentNumber = 1;
            let areDesksHidden = false;
            let currentLayout = { mode: 'standard', cols: 5, isPair: false, groupSize: 4 };
            let editingStudentId = null;

            // --- DOM Elements ---
            const uploadBtn = document.getElementById('upload-file');
            const fileInput = document.getElementById('file-input');
            const downloadCurrentCsvBtn = document.getElementById('download-current-csv');
            const deleteAllStudentsBtn = document.getElementById('delete-all-students');
            const studentNumberInput = document.getElementById('student-number');
            const studentNameInput = document.getElementById('student-name');
            const addStudentBtn = document.getElementById('add-student-btn');
            const studentListUl = document.getElementById('student-list');
            const seatingChartArea = document.getElementById('seating-chart-area');
            const seatingChartDiv = document.getElementById('seating-chart');
            const shuffleBtn = document.getElementById('shuffle-seats');
            const resetBtn = document.getElementById('reset-seats');
            const toggleHideBtn = document.getElementById('toggle-hide');
            const savePresetBtn = document.getElementById('save-preset');
            const exportPdfBtn = document.getElementById('export-pdf');
            const pairModeCheckbox = document.getElementById('pair-mode');
            const layoutColsInput = document.getElementById('layout-cols');
            const groupModeCheckbox = document.getElementById('group-mode');
            const groupSizeControl = document.getElementById('group-size-control');
            const groupSizeInput = document.getElementById('group-size');
            const applyLayoutBtn = document.getElementById('apply-layout');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');
            const fsShuffleBtn = document.getElementById('fs-shuffle-btn');
            const fsResetBtn = document.getElementById('fs-reset-btn');
            const fsToggleHideBtn = document.getElementById('fs-toggle-hide-btn');
            const fsSavePresetBtn = document.getElementById('fs-save-preset-btn');
            const fsExportPdfBtn = document.getElementById('fs-export-pdf-btn');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmModalMessage = document.getElementById('confirm-modal-message');
            const confirmModalYes = document.getElementById('confirm-modal-yes');
            const confirmModalNo = document.getElementById('confirm-modal-no');

            // --- Modal Logic ---
            let confirmCallback = null;
            function showConfirm(message, callback) {
                confirmModalMessage.textContent = message;
                confirmCallback = callback;
                confirmModalOverlay.style.display = 'flex';
            }
            function hideConfirm() {
                confirmModalOverlay.style.display = 'none';
                confirmCallback = null;
            }

            // --- Student Management ---
            function saveStudent() {
                const name = studentNameInput.value.trim();
                if (!name) {
                    alert('학생 이름을 입력하세요.');
                    return;
                }
                const number = parseInt(studentNumberInput.value);
                const gender = document.querySelector('input[name="gender"]:checked').value;

                if (students.some(s => s.number === number && s.id !== editingStudentId)) {
                    alert('이미 사용 중인 번호입니다.');
                    return;
                }
                
                if (editingStudentId) { // Update existing student
                    const student = students.find(s => s.id === editingStudentId);
                    if (student) {
                        student.number = isNaN(number) ? student.number : number;
                        student.name = name;
                        student.gender = gender;
                    }
                } else { // Add new student
                    const finalNumber = isNaN(number) ? nextStudentNumber : number;
                    students.push({ id: Date.now(), number: finalNumber, name, gender });
                }

                students.sort((a, b) => a.number - b.number);
                cancelEdit();
                updateStudentList();
                updateNextStudentNumber();
            }
            
            function editStudent(id) {
                const student = students.find(s => s.id === id);
                if (student) {
                    editingStudentId = id;
                    studentNumberInput.value = student.number;
                    studentNameInput.value = student.name;
                    document.querySelector(`input[name="gender"][value="${student.gender}"]`).checked = true;
                    addStudentBtn.textContent = '학생 수정';
                    studentNameInput.focus();
                }
            }

            function cancelEdit() {
                editingStudentId = null;
                studentNumberInput.value = '';
                studentNameInput.value = '';
                document.querySelector('input[name="gender"][value="M"]').checked = true;
                addStudentBtn.textContent = '학생 추가';
            }

            function removeStudent(id) {
                if (editingStudentId === id) {
                    cancelEdit();
                }
                students = students.filter(s => s.id !== id);
                updateStudentList();
                updateNextStudentNumber();
                if (desks.length > 0) {
                    if (students.length === 0) {
                        seatingChartDiv.innerHTML = '';
                        desks = [];
                    } else {
                         handleLayoutApply();
                    }
                }
            }
            
            function deleteAllStudents() {
                students = [];
                desks = [];
                seatingChartDiv.innerHTML = '';
                cancelEdit();
                updateStudentList();
                updateNextStudentNumber();
            }

            // --- File Handling (XLSX & CSV) ---
            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    processData(json);
                };
                reader.onerror = (e) => {
                    console.error("File reading error:", e);
                    alert("파일을 읽는 중 오류가 발생했습니다.");
                };
                reader.readAsArrayBuffer(file);
            }

            function normalizeGender(genderStr) {
                if (!genderStr) return 'M';
                const maleKeywords = ['남자', '남성', '남', 'man', 'male', 'm'];
                const femaleKeywords = ['여자', '여성', '여', 'woman', 'female', 'w', 'f'];
                const lowerGender = String(genderStr).trim().toLowerCase();

                if (maleKeywords.includes(lowerGender)) return 'M';
                if (femaleKeywords.includes(lowerGender)) return 'F';
                return 'M';
            }

            function processData(data) {
                const tempStudents = [];
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (row.length < 2 || !row[1]) continue;
                    
                    tempStudents.push({
                        rawNumber: row[0] || '',
                        name: String(row[1]).trim(),
                        gender: normalizeGender(row[2] || '')
                    });
                }
                
                let maxNum = 0;
                students = [];
                
                tempStudents.forEach(s => {
                    const num = parseInt(s.rawNumber, 10);
                    if (!isNaN(num)) {
                        students.push({ id: Date.now() + Math.random(), number: num, name: s.name, gender: s.gender });
                        if (num > maxNum) maxNum = num;
                    }
                });
                
                tempStudents.forEach(s => {
                    const num = parseInt(s.rawNumber, 10);
                    if (isNaN(num)) {
                        maxNum++;
                        while(students.some(s => s.number === maxNum)) {
                            maxNum++;
                        }
                        students.push({ id: Date.now() + Math.random(), number: maxNum, name: s.name, gender: s.gender });
                    }
                });

                students.sort((a, b) => a.number - b.number);
                updateStudentList();
                updateNextStudentNumber();
                alert(`${students.length}명의 학생 명단을 불러왔습니다.`);
                if (students.length > 0) {
                    handleLayoutApply();
                }
            }
            
            function downloadCurrentCsv() {
                if (students.length === 0) {
                    alert('저장할 학생 명단이 없습니다.');
                    return;
                }
                const header = ['번호', '이름', '성별'];
                const rows = students.map(s => [s.number, s.name, s.gender]);
                let csvContent = Papa.unparse([header, ...rows]);
                
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "현재_학생명단.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateStudentList() {
                studentListUl.innerHTML = '';
                students.forEach(student => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${student.number}. ${student.name} (${student.gender})</span>
                        <div class="list-btn-group">
                            <button class="btn-edit" data-id="${student.id}">수정</button>
                            <button class="btn-remove" data-id="${student.id}">X</button>
                        </div>
                    `;
                    studentListUl.appendChild(li);
                });
            }
            
            function updateNextStudentNumber() {
                if (students.length === 0) {
                    nextStudentNumber = 1;
                } else {
                    const maxNum = Math.max(0, ...students.map(s => s.number));
                    nextStudentNumber = maxNum + 1;
                }
                 studentNumberInput.placeholder = `번호 (${nextStudentNumber} 자동 부여)`;
            }

            // --- Layout Management ---
            function handleLayoutApply() {
                currentLayout.mode = groupModeCheckbox.checked ? 'group' : 'standard';
                currentLayout.cols = parseInt(layoutColsInput.value);
                currentLayout.isPair = pairModeCheckbox.checked;
                currentLayout.groupSize = parseInt(groupSizeInput.value);

                if (currentLayout.mode === 'standard' && (isNaN(currentLayout.cols) || currentLayout.cols < 1)) {
                     alert('한 줄에 배치할 인원(또는 쌍)은 1 이상이어야 합니다.');
                     return;
                }
                 if (currentLayout.mode === 'group' && (isNaN(currentLayout.groupSize) || currentLayout.groupSize < 2)) {
                     alert('한 모둠의 인원은 2 이상이어야 합니다.');
                     return;
                }
                createLayout();
            }

            function createLayout() {
                if (students.length === 0) {
                    seatingChartDiv.innerHTML = '';
                    desks = [];
                    return;
                }
                
                desks = [];
                for (let i = 0; i < students.length; i++) {
                    const student = students[i];
                    const desk = createDeskElement(student, i);
                    desks.push({ element: desk, student: student, fixed: false, originalIndex: i, rotation: 0 });
                }
                arrangeAndScaleDesks();
            }
            
            function arrangeInGroups() {
                seatingChartDiv.innerHTML = ''; // Clear for group cards
                const groupSize = currentLayout.groupSize;
                const studentCount = desks.length;
                const numGroups = Math.ceil(studentCount / groupSize);

                for (let i = 0; i < numGroups; i++) {
                    const groupCard = document.createElement('div');
                    groupCard.className = 'group-card';
                    groupCard.innerHTML = `<div class="group-title">${i + 1}모둠</div>`;
                    
                    const desksInGroup = desks.slice(i * groupSize, (i + 1) * groupSize);
                    
                    let cardWidth = 0;
                    let cardHeight = 0;

                    desksInGroup.forEach((deskData, j) => {
                        const deskElement = deskData.element;
                        const deskWidth = 100;
                        const deskHeight = 60;
                        const margin = 10;
                        
                        let x = (j % 2) * (deskWidth + margin);
                        let y = Math.floor(j / 2) * (deskHeight + margin);
                        
                        deskElement.style.left = `${x}px`;
                        deskElement.style.top = `${y}px`;
                        groupCard.appendChild(deskElement);

                        cardWidth = Math.max(cardWidth, x + deskWidth);
                        cardHeight = Math.max(cardHeight, y + deskHeight);
                    });
                    
                    groupCard.style.width = `${cardWidth}px`;
                    groupCard.style.height = `${cardHeight}px`;
                    seatingChartDiv.appendChild(groupCard);
                }
            }

            function arrangeInStandard() {
                 seatingChartDiv.innerHTML = ''; // Clear for individual desks
                 desks.forEach(deskData => seatingChartDiv.appendChild(deskData.element));

                 const { cols, isPair } = currentLayout;
                 const studentCount = desks.length;
                 const deskWidth = 100;
                 const deskHeight = 60;
                 const hGap = 20;
                 const vGap = 40;
                 const pairGap = 10;

                 for (let i = 0; i < studentCount; i++) {
                    const desk = desks[i].element;
                    let x, y;
                    
                    if (isPair) {
                        const pairIndex = Math.floor(i / 2);
                        const row = Math.floor(pairIndex / cols);
                        const colInRow = pairIndex % cols;
                        const isRightInPair = i % 2 !== 0;

                        const pairWidth = deskWidth * 2 + pairGap;
                        x = colInRow * (pairWidth + hGap) + (isRightInPair ? deskWidth + pairGap : 0);
                        y = row * (deskHeight + vGap);
                    } else {
                        const row = Math.floor(i / cols);
                        const col = i % cols;
                        x = col * (deskWidth + hGap);
                        y = row * (deskHeight + vGap);
                    }
                    
                    desk.style.left = `${x}px`;
                    desk.style.top = `${y}px`;
                }
            }

            function arrangeAndScaleDesks() {
                if (desks.length === 0) return;
                
                seatingChartDiv.style.transform = 'scale(1)';
                desks.forEach(d => { d.element.style.transform = `rotate(${d.rotation}deg)`; });

                if (currentLayout.mode === 'group') {
                    arrangeInGroups();
                    const groupCards = Array.from(seatingChartDiv.children);
                    const groupsPerRow = Math.max(1, Math.floor(seatingChartArea.clientWidth / 350));
                    const groupGap = 30;
                    
                    let currentX = 0;
                    let currentY = 0;
                    let maxRowHeight = 0;

                    groupCards.forEach((card, i) => {
                        if (i > 0 && i % groupsPerRow === 0) {
                            currentX = 0;
                            currentY += maxRowHeight + groupGap;
                            maxRowHeight = 0;
                        }
                        card.style.left = `${currentX}px`;
                        card.style.top = `${currentY}px`;
                        currentX += card.offsetWidth + groupGap;
                        maxRowHeight = Math.max(maxRowHeight, card.offsetHeight);
                    });

                } else {
                    arrangeInStandard();
                }

                let maxW = 0, maxH = 0;
                Array.from(seatingChartDiv.children).forEach(child => {
                    maxW = Math.max(maxW, child.offsetLeft + child.offsetWidth);
                    maxH = Math.max(maxH, child.offsetTop + child.offsetHeight);
                });

                const containerW = seatingChartArea.clientWidth;
                const containerH = seatingChartArea.clientHeight;
                const teacherDeskHeight = 50;
                const teacherDeskMargin = 30;
                const teacherDeskOffset = teacherDeskHeight + teacherDeskMargin;
                const availableH = containerH - teacherDeskOffset;
                
                const scale = Math.min(containerW / (maxW + 20), availableH / (maxH + 20), 1);
                
                seatingChartDiv.style.width = `${maxW}px`;
                seatingChartDiv.style.height = `${maxH}px`;
                seatingChartDiv.style.transform = `scale(${scale})`;

                const scaledWidth = maxW * scale;
                const newLeft = (containerW - scaledWidth) / 2;
                const newTop = teacherDeskOffset;

                seatingChartDiv.style.left = `${Math.max(0, newLeft)}px`;
                seatingChartDiv.style.top = `${newTop}px`;
            }

            function createDeskElement(student, index) {
                const desk = document.createElement('div');
                desk.className = 'desk';
                desk.dataset.index = index;
                desk.innerHTML = `
                    <div class="desk-header">
                        <button class="desk-btn btn-rotate">🔄</button>
                        <button class="desk-btn btn-fix">고정</button>
                    </div>
                    <div class="student-info">
                        <div>
                            <span class="student-number"></span>.
                            <span class="student-name"></span>
                        </div>
                        <div class="student-gender"></div>
                    </div>
                `;
                updateDeskInfo(desk, student);
                makeDraggable(desk);
                return desk;
            }

            // --- Core Functions ---
            function shuffleSeats(event) {
                if (event && event.ctrlKey) {
                    loadPreset();
                    return;
                }
                const fixedStudents = desks.filter(d => d.fixed).map(d => d.student);
                const unfixedDesks = desks.filter(d => !d.fixed);
                let unfixedStudents = students.filter(s => !fixedStudents.some(fs => fs.id === s.id));

                for (let i = unfixedStudents.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [unfixedStudents[i], unfixedStudents[j]] = [unfixedStudents[j], unfixedStudents[i]];
                }

                unfixedDesks.forEach((desk, i) => {
                    desk.student = unfixedStudents[i];
                    updateDeskInfo(desk.element, desk.student);
                });
            }
            
            function resetSeats() {
                if (desks.length === 0) return;
                desks.sort((a,b) => a.originalIndex - b.originalIndex);
                students.sort((a,b) => a.number - b.number);
                desks.forEach((desk, i) => {
                    desk.student = students[i];
                });
                createLayout();
            }

            function updateDeskInfo(deskElement, student) {
                const numSpan = deskElement.querySelector('.student-number');
                const nameSpan = deskElement.querySelector('.student-name');
                const genderSpan = deskElement.querySelector('.student-gender');
                if (student) {
                    numSpan.textContent = student.number;
                    nameSpan.textContent = student.name;
                    genderSpan.textContent = `(${student.gender})`;
                } else {
                    numSpan.textContent = '';
                    nameSpan.textContent = '빈자리';
                    genderSpan.textContent = '';
                }
            }

            function toggleDeskFix(deskElement) {
                const deskData = desks.find(d => d.element === deskElement);
                if (deskData) {
                    deskData.fixed = !deskData.fixed;
                    deskElement.classList.toggle('fixed');
                    deskElement.querySelector('.btn-fix').textContent = deskData.fixed ? '해제' : '고정';
                }
            }
            
            function rotateDesk(deskElement) {
                const deskData = desks.find(d => d.element === deskElement);
                if (deskData) {
                    deskData.rotation = (deskData.rotation + 90) % 360;
                    deskElement.style.transform = `rotate(${deskData.rotation}deg)`;
                }
            }
            
            function toggleHideAll() {
                areDesksHidden = !areDesksHidden;
                desks.forEach(d => d.element.classList.toggle('hidden', areDesksHidden));
                const buttonText = areDesksHidden ? '전체 공개' : '책상 가리기';
                toggleHideBtn.textContent = buttonText;
                fsToggleHideBtn.textContent = buttonText;
            }
            
            function revealSingleDesk(deskElement) {
                if(areDesksHidden) {
                    deskElement.classList.remove('hidden');
                }
            }

            // --- Drag and Drop with Collision Detection ---
            function makeDraggable(element) {
                element.onmousedown = e => {
                    if (e.target.classList.contains('desk-btn')) return;
                    e.preventDefault();
                    const deskData = desks.find(d => d.element === element);
                    if (!deskData || deskData.fixed) return;
                    
                    element.classList.add('dragging');

                    const isPair = currentLayout.mode === 'standard' && currentLayout.isPair;
                    let partnerElement = null;
                    let partnerStartLeft = 0;
                    let partnerStartTop = 0;

                    if (isPair) {
                        const myIndex = deskData.originalIndex;
                        const partnerIndex = (myIndex % 2 === 0) ? myIndex + 1 : myIndex - 1;
                        const partnerData = desks.find(d => d.originalIndex === partnerIndex);
                        if (partnerData) {
                            partnerElement = partnerData.element;
                            partnerElement.classList.add('dragging');
                            partnerStartLeft = partnerElement.offsetLeft;
                            partnerStartTop = partnerElement.offsetTop;
                        }
                    }

                    const scale = parseFloat(seatingChartDiv.style.transform.replace('scale(', '')) || 1;
                    const startLeft = element.offsetLeft;
                    const startTop = element.offsetTop;
                    const startX = e.clientX;
                    const startY = e.clientY;

                    document.onmousemove = e_drag => {
                        e_drag.preventDefault();
                        
                        const dx = (e_drag.clientX - startX) / scale;
                        const dy = (e_drag.clientY - startY) / scale;
                        
                        element.style.left = `${startLeft + dx}px`;
                        element.style.top = `${startTop + dy}px`;

                        if (partnerElement) {
                            partnerElement.style.left = `${partnerStartLeft + dx}px`;
                            partnerElement.style.top = `${partnerStartTop + dy}px`;
                        }
                    };

                    document.onmouseup = () => {
                        element.classList.remove('dragging');
                        if (partnerElement) {
                            partnerElement.classList.remove('dragging');
                        }
                        document.onmouseup = null;
                        document.onmousemove = null;
                    };
                };
            }

            // --- Preset and PDF Functions ---
            function savePreset() {
                if (desks.length === 0) {
                    alert('저장할 배치 정보가 없습니다.');
                    return;
                }
                const preset = {
                    layout: currentLayout,
                    deskStates: desks.map(d => ({
                        studentId: d.student ? d.student.id : null,
                        fixed: d.fixed,
                        left: d.element.style.left,
                        top: d.element.style.top,
                        rotation: d.rotation
                    }))
                };
                localStorage.setItem('seatingChartPreset', JSON.stringify(preset));
                alert('현재 배치를 저장했습니다.');
            }

            function loadPreset() {
                const presetJSON = localStorage.getItem('seatingChartPreset');
                if (!presetJSON) {
                    alert('저장된 배치 정보가 없습니다.');
                    return;
                }
                const preset = JSON.parse(presetJSON);
                if (preset.deskStates.length !== students.length) {
                    alert('저장된 배치의 학생 수와 현재 학생 수가 다릅니다.');
                    return;
                }

                currentLayout = preset.layout;
                groupModeCheckbox.checked = currentLayout.mode === 'group';
                pairModeCheckbox.checked = currentLayout.isPair;
                layoutColsInput.value = currentLayout.cols;
                groupSizeInput.value = currentLayout.groupSize;
                toggleLayoutControls();
                
                createLayout();

                preset.deskStates.forEach((p, i) => {
                    const deskData = desks[i];
                    if(!deskData) return;

                    const student = students.find(s => s.id === p.studentId);
                    deskData.student = student;
                    deskData.fixed = p.fixed;
                    deskData.rotation = p.rotation || 0;
                    updateDeskInfo(deskData.element, student);
                    deskData.element.classList.toggle('fixed', p.fixed);
                    deskData.element.querySelector('.btn-fix').textContent = p.fixed ? '해제' : '고정';
                    deskData.element.style.left = p.left;
                    deskData.element.style.top = p.top;
                    deskData.element.style.transform = `rotate(${deskData.rotation}deg)`;
                });
                arrangeAndScaleDesks();
                alert('저장된 배치를 불러왔습니다.');
            }

            function exportToPDF() {
                const chartArea = document.getElementById('seating-chart-area');
                alert('PDF 생성을 시작합니다. 잠시만 기다려주세요...');
                html2canvas(chartArea, { scale: 2 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                        unit: 'px',
                        format: [canvas.width, canvas.height]
                    });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save("좌석배치도.pdf");
                }).catch(err => {
                    console.error("PDF 생성 오류:", err);
                    alert("PDF 생성에 실패했습니다. 콘솔을 확인해주세요.");
                });
            }
            
            function toggleLayoutControls() {
                const isGroup = groupModeCheckbox.checked;
                document.getElementById('standard-layout-controls').style.display = isGroup ? 'none' : 'block';
                document.getElementById('group-size-control').style.display = isGroup ? 'flex' : 'none';
            }
            
            function toggleFullscreen() {
                document.body.classList.toggle('fullscreen-mode');
                fsToggleHideBtn.textContent = areDesksHidden ? '전체 공개' : '책상 가리기';
                setTimeout(arrangeAndScaleDesks, 50);
            }

            // --- Event Listeners ---
            addStudentBtn.addEventListener('click', saveStudent);
            studentListUl.addEventListener('click', e => {
                if (e.target.classList.contains('btn-remove')) {
                    removeStudent(parseFloat(e.target.dataset.id));
                } else if (e.target.classList.contains('btn-edit')) {
                    editStudent(parseFloat(e.target.dataset.id));
                }
            });
            
            // Electron & Web File Upload Logic
            if (window.electronAPI) {
                uploadBtn.addEventListener('click', () => {
                    window.electronAPI.openFileDialog();
                });
                window.electronAPI.onFileOpened((file) => {
                    const workbook = XLSX.read(file.content, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    processData(json);
                });
            } else {
                uploadBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileUpload);
            }

            downloadCurrentCsvBtn.addEventListener('click', downloadCurrentCsv);
            deleteAllStudentsBtn.addEventListener('click', () => {
                showConfirm('정말로 모든 학생 명단을 삭제하시겠습니까?', deleteAllStudents);
            });
            
            confirmModalYes.addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirm();
            });
            confirmModalNo.addEventListener('click', hideConfirm);
            
            applyLayoutBtn.addEventListener('click', handleLayoutApply);
            groupModeCheckbox.addEventListener('change', toggleLayoutControls);
            
            seatingChartDiv.addEventListener('click', e => {
                const target = e.target;
                const deskElement = target.closest('.desk');
                if (!deskElement) return;

                if (target.classList.contains('btn-fix')) {
                    toggleDeskFix(deskElement);
                } else if (target.classList.contains('btn-rotate')) {
                    rotateDesk(deskElement);
                } else {
                    revealSingleDesk(deskElement);
                }
            });
            shuffleBtn.addEventListener('click', shuffleSeats);
            resetBtn.addEventListener('click', resetSeats);
            toggleHideBtn.addEventListener('click', toggleHideAll);
            savePresetBtn.addEventListener('click', savePreset);
            exportPdfBtn.addEventListener('click', exportToPDF);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            exitFullscreenBtn.addEventListener('click', toggleFullscreen);
            fsShuffleBtn.addEventListener('click', shuffleSeats);
            fsResetBtn.addEventListener('click', resetSeats);
            fsToggleHideBtn.addEventListener('click', toggleHideAll);
            fsSavePresetBtn.addEventListener('click', savePreset);
            fsExportPdfBtn.addEventListener('click', exportToPDF);
            
            window.addEventListener('resize', arrangeAndScaleDesks);
            
            // --- Initial Setup ---
            updateNextStudentNumber();
        });
    </script>
</body>
</html>
